---
layout: post
title: 游戏玩家数据回档
tags: xgame xGame 游戏服务器 服务器 游戏 回档
---

## 回档的定义

玩家或全服的数据被重置到之前的某个时间，玩家丢失了一段时间的数据。

## 为什么会回档

在ARPG、RPG游戏中比如玩家血量、位置、场景中的角色等，数据变化很快，比如hp、mp的恢复 1点/0.5 秒的话，全服，1000人，hp、mp的update的频度就是 2000 * 2 = 4000次/s, 而hp、mp、sp只是游戏中的一部分瞬变数据，还有成吨的数据要更新哦！！！

社交游戏一般不存在这一的问题。

很多游戏的做法是玩家登陆的时候一次loading这个玩家的所有数据，放在玩家、系统的内存中，再定时、玩家下线时全部落地回DB。

定时比如是3、5分钟，在这么长的一个时间周期中，如果程序发生异常、崩溃等数据可能会丢失。那是否说发生服务异常时强制立刻存档就可以避免丢失呢？

一方面，异常时存档是是可以适当减少丢失，但是很多事务型的数据会带来严重的逻辑错误或者事故。比如说一个函数的逻辑是: step 1 检查金币， step 2 给予物品，step 3扣除金币，如果step 3发送错误，step 2 内容存档完成，玩家就会利用这个操作来反复的刷物品。所以我们的经验是把逻辑反过来写，把step 1的check和step 3的扣除做成一个函数，在这种情况下如果step 3发错错误，金币被扣除，单玩家未得到物品，来避免这种漏洞和bug给公司带来损失。

另一方面，异常就存档不是所有的情况都可行，比如c++很多内存crash，process就挂掉了；在比如Java的OOM异常，也是会进程之间挂掉，这些情况都是没有捕获异常的窗口。

## 回档了又该怎么办？

回档是非常严重的事故，善后都比较麻烦，一般的做法是全服补偿、玩家补偿、日志找回等，都是一些补偿的方式。

## 可以不回档吗？

回档的问题本质上是，数据在游戏服务器进程的内存中存储，定时落地。解决这个问题，我的思路有两个：

1. 数据即时落地
2. 玩家内存游戏数据 由 非游戏进程持有

我在方向2上面的没什么经验，可能是共享内存的方式。

方向1上回过头来看，不就是直接操作数据库吗？不是说效率不够吗？诚然对应pos、hp、mp等等这些变化频度超高的时间用db是不现实的，但每次hp、mp、sp变化真的需要固化到DB吗？万一丢失了后果如何？

设计、优化的核心是在于对问题的理解，对于游戏，每种游戏数据有他自身的特点，我们按数据的冷热度、重要性、变化（读写）率来取分数据，再加上适当的缓存方案，是可以得到一个可行的即时落地DB方案，来解决定时落地DB的问题。

## 游戏数据库的操作特点

- 玩家数据
    + 只修改一条记录
    + 都是玩家自己修改，不被其他玩家修改
    + 读少、写多
    + 关键数据变化比较少，很多是批量变化，比如level、vipLevel、gold、crystal、skills
    + 变化快的数据一般不是非常重要，比如pos、hp、mp等
    
- 背包、好友、公会、任务等数据
    + 有多条记录
    + 读多，写少，写有操作门槛，比如20级才能建公会
    + 修改一般是单挑条修改

## 最后

总的的思路是：

-  重要数据、不常改的数据即时写DB
-  不重要、易变、临时数据存内存，定时或逻辑窗口写回DB
-  读写频度高的数据，局部内存化、适当运用redis/memcached等缓存

