---
layout: post
title: 游戏开发的SCM管理
tags: xgame svn git hg
category: xgame
---


项目在经历：初期开发、里程碑、上线运营、多平台差异之后也对版本控制有不同的要求。在每个阶段有各自的特点，版本控制的难度是逐步攀升。
svn/git作为最主流的版本控制工具，svn我一直使用（也使用过2年的hg），也比较熟悉,先阶段只使用svn，正在考虑git相关的方案。

# 版本分支模型和开发的阶段

## 开发期

开发期，应该是程序、策划的蜜月期，尝试各种想法，没有太严格的版本压力，无分支管理也ok，不管你什么办法，能搞出一个版本就行，版本也不需要很严格的备份、追溯。
**有版本管理就行**

## 里程碑

从里程碑开始，大家就会意识到，版本控制不只是一个备份工具。
我们需要一个固定的版本、发布的二进制程序、可以持续修复发布版本的bug的地方等等，分支就必不可少了。
对于svn，安装svnbook所诉，一般有两种分支模式：发布分支和特性分支。我们采用的是其实不算很标准的特性分支：

    /branches/dev       功能开发分支
    /branches/alpha     预发布分支
    /trunk              发布分支

没有临时分支，dev开发功能，功能开发完毕单元测试通过，合并到alpha提交测试组，测试通过合并trunk上线。整个分支流程按照一般的开发流程走。一切都很美好！！！

## 上线运营

快乐总是短暂的，开发更是如此。

随着项目的上线运营，上面的模型慢慢开始不好用了，问题是什么呢？

在上面的dev-alpha-trunk模型中，dev都是既定的全部内容，整个内容开发完了，进入下一个阶段，这种设定其实过于理想，有特别对于游戏开发这种，设定具体尝试下，需要天天变得项目，有几个问题其实是需要 *特性分支* 的方式来解决的。

- 多个版本同时开发：比如说v1.0内容量少本周可以完成，v1.1内容要求下周发布，开发工作量是2周，本周就必须开始，v1.1的内容不应该进入本周的版本。
- 客户端、服务器等同一个功能开发难度不同，周期不同。
- 单一系统功能计划可能被调整，这里面的原因可能很多，不尽然都合理，比如老板就好这个功能在改改才能上、平台有要求（他们是大爷），但你必须处理好这些情况。我们需要有一个原则，做最坏的打算，提供更多可行的解决问题的方案，**能够处理不合理的突发事件是需要设计的一部分！**
- **线上同时再跑的有很多个版本！！！**

这些问题，都要求有更多的分支，处理差异，又要求分支间共享bug fix、new feature，这本身其实是个矛盾的问题！

我们需要更多的分支：引入特性（功能）分支、临时分支，hot-fix分支，制定workflow，明确分支合并规则就尤为重要！

啰嗦一句：**“分支合并(merge)真的不容易！！！”**

分支svn处理起来比较重，是时候考虑git了!

## Git workflow

![git-workflow]({{site.url}}/img/git-model@2x.png)
关于git的工作流，大家都有各自的方式。参考[http://nvie.com/posts/a-successful-git-branching-model/](http://nvie.com/posts/a-successful-git-branching-model/)，对于发布，特性开发，临时分支，hot-fix等等问题，我非常认同。


git又要怎么玩呢？我们先了解一下游戏仓库的特点

# 游戏仓库的特点

- 仓库庞大，几十上百GB，一个分支
- 分支众多，各种版本，特别对于开服类型的游戏，同一个代理商就有多个版本（2+）在同时运行
- 提交者众多，程序、美术、策划，SCM水平参差不齐
    + 程序，必须非常懂，帮助团队，处理版本控制的全部问题
    + 策划，有分支的概念，不用谈合并
    + 美术，倾向于无视版本控制
- 图片、配置数据体积大，数量多
- 资源一般分源、和输出
    + psd  => png/jpg
    + excel  => xml/csv/json
    + 代码   => exe/jar/binary
    + image => altas
    + ...

# 方案

## 两个SVM、两个仓库
    - 代码仓库，使用git
    - 发布仓库，使用svn，固定、少分支

## 为什么是分两个仓库这么麻烦？

1. git当文件大于1G时比较慢；
2. git对于策划，美术太复杂了，学习成本也太高，这不应该是他们关注的问题（特别是美术）；
3. 发布的版本是一个阶段，是二进制的内容。使用SCM发布一个版本号，比一个10G的zip比，快上几个世纪，DevOps才有戏；
4. 所有发布内容应该是固化、可追溯的；
5. 代码分支需要经常切换，切换需要快速；
6. 回避git 在 large size binary file处理方面的问题；

一方面我们使用git满足了，程序对分支的巨大需求，切换到特性分支的工作方式。另一方面不增加策划、美术的学习成本，简化分支对他们干扰和困惑。


